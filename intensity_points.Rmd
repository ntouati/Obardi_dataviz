---
title: "Analyse des rébellions : la Guerre des farines - Intensité et participants"
author: "N. Touati et V. Gay"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    highlight: tango
  pdf_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Introduction

Ce notebook analyse les rébellions des farines en croisant l'intensité des événements avec la fiabilité des données sur le nombre de participants.

# 1. Chargement des packages

```{r packages}
library(sf)
library(dplyr)
library(ggplot2)
library(janitor)
library(stringr)
library(leaflet)
library(viridis)
```

# 2. Préparation des données

## 2.1 Chargement et conversion en objet spatial

```{r load-data}
# Chargement des données 
rebellions_csv <- read.csv("C:/Users/Najla Touati/Dropbox/Najla - ObARDI/Dynamiques de la révolte/shapefiles/REBELLIONS/rebellions_farines.csv")

# Convertir en objet sf (projection Lambert-93)
rebellions_sf <- st_as_sf(
  rebellions_csv, 
  coords = c("lon_cassini_rgf", "lat_cassini_rgf"),
  crs = 2154
)

# Vérifier le résultat
print(rebellions_sf)
```

## 2.2 Création de la variable intensité qualifiée

```{r intensity-qualified}
rebellions_intensity <- rebellions_sf %>%
  mutate(intensite_qualifiee = case_when(
    # Intensité forte ET bien documentée
    intensity == 3 & part_nb_flag == 2 ~ "Forte_Certaine",
    
    # Intensité forte MAIS mal documentée
    intensity == 3 & part_nb_flag %in% c( 3, 4, 5, 6) ~ "Forte_Incertaine",
    
    # Intensité modérée/faible ET bien documentée
    intensity %in% c(1, 2) & part_nb_flag == 2 ~ "Faible_Certaine",
    
    # Intensité modérée/faible ET mal documentée
    intensity %in% c(1, 2) & part_nb_flag %in% c(1, 3, 5) ~ "Faible_Incertaine"
  ))
```

# 3. Analyses descriptives

## 3.1 Distribution de l'intensité qualifiée

```{r distribution-table}
# Distribution en effectifs
table(rebellions_intensity$intensite_qualifiee)

# Distribution en pourcentages
prop.table(table(rebellions_intensity$intensite_qualifiee)) * 100
```

## 3.2 Statistiques par catégorie

```{r stats-by-category}
rebellions_intensity %>%
  group_by(intensite_qualifiee) %>%
  summarise(
    n = n(),
    pourcentage = round(n() / nrow(rebellions_intensity) * 100, 2),
    intensite_moyenne = round(mean(intensity), 2),
    pct_nombre_precis = round(sum(part_nb_flag == 2) / n() * 100, 2)
  ) %>%
  arrange(desc(n))
```

## 3.3 Tables croisées

```{r cross-tables}
# Intensité brute x Intensité qualifiée
table(rebellions_intensity$intensity, rebellions_intensity$intensite_qualifiee)

# Flag participants x Intensité qualifiée
table(rebellions_intensity$part_nb_flag, rebellions_intensity$intensite_qualifiee)

# Table croisée complète
rebellions_intensity %>%
  tabyl(intensity, part_nb_flag, intensite_qualifiee)
```

# 4. Visualisations

## 4.1 Graphique en barres

```{r bar-plot, fig.width=10, fig.height=6}
ggplot(rebellions_intensity, aes(x = intensite_qualifiee, fill = as.factor(intensity))) +
  geom_bar(position = "stack") +
  labs(
    title = "Distribution de l'intensité qualifiée",
    x = "Intensité qualifiée", 
    y = "Nombre de rébellions",
    fill = "Intensité brute"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# 5. Préparation pour la cartographie

## 5.1 Nettoyage et transformation

```{r prepare-map-data}
# Conversion en WGS84 et nettoyage de part_nb
rebellions_intensity_filtr <- rebellions_intensity %>%
  st_drop_geometry() %>%
  st_as_sf(
    coords = c("lon_cassini_wgs", "lat_cassini_wgs"),
    crs = 4326
  ) %>%
  mutate(
    part_nb = na_if(part_nb, ".c"),
    part_nb = as.numeric(part_nb)
  )
```

## 5.2 Création des variables de visualisation

```{r create-viz-vars}
rebellions_intensity_filtr <- rebellions_intensity_filtr %>%
  mutate(
    intensite_num = case_when(
      intensite_qualifiee == "Faible_Incertaine" ~ 1,
      intensite_qualifiee == "Faible_Certaine"   ~ 2,
      intensite_qualifiee == "Forte_Incertaine"  ~ 3,
      intensite_qualifiee == "Forte_Certaine"    ~ 4,
      TRUE ~ NA_real_
    ),
    opacite = ifelse(intensite_qualifiee == "Certaine", 1, 0.65),
    rayon = pmax(2, sqrt(part_nb))
  )
```

# 6. Carte interactive

```{r leaflet-map, fig.width=12, fig.height=8}
# Palette de couleurs
pal <- colorNumeric(
  palette = viridis(4, direction = -1),
  domain = rebellions_intensity_filtr$intensite_num
)

# Carte Leaflet avec dimensions optimisées
leaflet(
  data = rebellions_intensity_filtr,
  width = "100%",
  height = 700
) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(
    radius = ~rayon,
    color = ~pal(intensite_num),
    fillOpacity = ~opacite,
    stroke = TRUE,
    weight = 0.8,
    opacity = 0.5,
    popup = ~paste0(
      "<b>Participants :</b> ", part_nb, "<br>",
      "<b>Intensité :</b> ", intensite_qualifiee, "<br>",
      "<b>Code numérique :</b> ", intensite_num
    )
  ) %>%
  addLegend(
    "bottomright",
    colors = pal(1:4),
    labels = c(
      "Faible Incertaine", 
      "Faible Certaine", 
      "Forte Incertaine", 
      "Forte Certaine"
    ),
    title = "Intensité qualifiée"
  )
```

```

# 7. Export des données

```{r export-data, eval=FALSE}
# Export en geopackage
st_write(
  rebellions_intensity_filtr,
  dsn = "C:/Users/Najla Touati/Dropbox/temporaire/obardi_R/data/bailliages/rebellions_intensity.gpkg",
  driver = "GPKG"
)
```

