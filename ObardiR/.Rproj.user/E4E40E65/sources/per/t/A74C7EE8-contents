---
title: "Carte par Points de la Population (1793)"
author: "N. Touati et V. Gay"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    highlight: tango
  pdf_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 8
)
```

# Carte par Points (Dot Density Map) de la Population par bailliage en 1793

Ce notebook génère une carte par points pour visualiser la répartition de la population connue des bailliages en 1793.

------------------------------------------------------------------------

```{r Chargement des packages} 
library(sf)
library(dplyr)
library(ggplot2)
library(tidyr)
library(packcircles)
library(here)
```
## 1. Préparation des données
```{r load-data}

# Chargement des shapefiles
paroisses_sf_pts <- st_read(here("data", "BAILLIAGES_1789_BRETTE_POINTS.shp"), quiet = TRUE)

bailliage_sf <- st_read(here("data", "BAILLIAGES_1789_BRETTE.shp"), quiet = TRUE)

pop_1793 <- read.csv(here("data", "pop_1793.csv"))

communes_sf <-st_read(here("data", "COMMUNES_BRETTE.shp"), quiet = TRUE)

```
## 2. Calculs des variables
```{r calculs des variables}
# === 2. CALCULS DES VARIABLES ===
# Jointure 1 : jointure des champs de pop10793 vers paroisses_points
pop_1793_select <- pop_1793 %>%
  dplyr::select(noacass, pop_an3_val)

paroisses_pts <- paroisses_sf_pts %>%
  dplyr::left_join(pop_1793_select, by = "noacass") %>%
  dplyr::select(
    noacass,
    pop_an3_val,
    geometry
  )
#bascule en polygone paroisses point vers paroisses polygone
paroisses_bail <- bailliage_sf %>%     # sf POLYGON
  st_join(
    paroisses_pts,                      # sf POINT
    join = st_contains
  )%>% # Calcul de la surface totale des paroisses en km²
  mutate(
    surface_km2 = as.numeric(st_area(geometry)) / 1000000
  ) 

# Agrégation des données par bailliage
bailliage_agr <- paroisses_bail %>%
  group_by(BAIL_ID) %>%
  summarise(
    surface_totale_km2   = sum(surface_km2, na.rm = TRUE),
    surface_avec_pop_km2 = sum(surface_km2[!is.na(pop_an3_val)], na.rm = TRUE),
    surface_sans_pop_km2 = sum(surface_km2[ is.na(pop_an3_val)], na.rm = TRUE),
    population_connue    = sum(pop_an3_val, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    densite_hab_km2 = population_connue / surface_avec_pop_km2,
    coefficient_incertitude_pct =
      surface_sans_pop_km2 / surface_totale_km2 * 100
  )

#Agrégation des données par communes
communes_agr <- paroisses_bail %>%
  # Renommer la colonne pour l'agrégation
  rename(INSEE_COM = CL_INSEE) %>%
  group_by(INSEE_COM) %>%   # agrégation par code INSEE
  summarise(
    surface_totale_km2   = sum(surface_km2, na.rm = TRUE),
    surface_avec_pop_km2 = sum(surface_km2[!is.na(pop_an3_val)], na.rm = TRUE),
    surface_sans_pop_km2 = sum(surface_km2[ is.na(pop_an3_val)], na.rm = TRUE),
    population_connue    = sum(pop_an3_val, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    densite_hab_km2 = population_connue / surface_avec_pop_km2,
    coefficient_incertitude_pct =
      surface_sans_pop_km2 / surface_totale_km2 * 100
  )
```

La population connue est la somme des populations disponibles et connues d'après les sources.

## 3. Carte par points (dot density map)

### 3.1 Calcul pour qu'un point = 2500 habitants

```{r preparation des donnees et calcul des points} 
# # Préparer les données
# bailliage_dots <- bailliage_agr %>%
#   filter(!is.na(population_connue) & population_connue > 0) %>%
#   mutate(nb_points = round(population_connue / 10, 0))

bailliage_dots <- communes_agr %>%
  filter(!is.na(population_connue) & population_connue > 0) %>%
  mutate(nb_points = round(population_connue / 2500, 0))

#
# # Générer les points aléatoirement dans chaque bailliage
dots <- st_sample(bailliage_dots, bailliage_dots$nb_points,
                  type = "random", exact = TRUE)

# Créer des cercles autour des points (ajuster le radius selon projection)
circles <- st_buffer(dots, dist = 1000)  # 1000 mètres = 1 km
# Convertir pour ggplot2
dots_sf    <- st_as_sf(dots)
circles_sf <- st_as_sf(circles)


# #Export en geopackage
# st_write(
#   dots_sf,
#   dsn        = here("data", "bailliage_dens.gpkg"), 
#   layer      = "dots_pts",
#   driver     = "GPKG", 
#   delete_dsn = TRUE)

```

### 3.2 Cartogramme de Dorling
 Représentation spatiale qui vise à remplacer les polygones par des cercles proportionnels à une variable données respectant au maximum la position spatiale des polygones.

```{r cartogramme Dorling}
library(cartogram)
library(scales)

# communes_dorling <- communes_agr %>%
#   filter(
#     !is.na(population_connue),
#     population_connue > 0,
#     !is.na(coefficient_incertitude_pct)
#   ) 

dorling_viz <- cartogram_dorling(
  x = communes_agr,
  weight = "population_connue",
  k = 1
)


```



### 3.3 Conception cartographique
```{r carte de densité par points}
# === CARTE ggplot2 ===

map_dot <- ggplot() +
  geom_sf(
    data = bailliage_sf, 
    fill = "#e8d0ca", 
    color = "#e8d0ca", 
    linewidth = 0.1
  ) +
  # Couche pour population_connue == 0 avec aes() pour la légende
  geom_sf(
    data = bailliage_agr %>% filter(population_connue == 0),
    aes(fill = "No data"),  # créer une entrée dans la légende
    color = "grey40",
    linewidth = 0.1
  ) +
  
  # Définir manuellement la couleur pour "No data"
  scale_fill_manual(
    name = "",
    values = c("No data" = "grey40"),
    guide = guide_legend(override.aes = list(alpha = 0.999))
  ) +
  geom_sf(
    data = circles_sf, 
    fill = "#283445", 
    color = "#283445", 
    linewidth = 0.05
  ) +
  
  labs(
    title = "Point cartogram of the population by bailliage in 1793",
    subtitle = "1 point = 5,000 inhabitants",
    caption = paste(
      "Source: Cristofoli et al. (2017–2021). Données Cassini-communes France. EHESS.\nGay, V., Gobbi, P. E., and Goñi, M. « Bailliages in 1789 France », 2023.\nConception: N. Touati, 2025"
    )
  ) +
  
  theme_void() +
  theme(
    text = element_text(color = "#22211d"),
    plot.background = element_rect(fill = "#f5f5f2", color = NA),
    panel.background = element_rect(fill = "#f5f5f2", color = NA),
    legend.background = element_rect(fill = "#f5f5f2", color = NA),
    
    plot.title = element_text(
      size = 15, 
      hjust = 0.5, 
      color = "#4e4d47",
      face = "bold",
      margin = margin(b = -0.1, t = 0.4, l = 2, unit = "cm")
    ),
    
    plot.subtitle = element_text(
      size = 10, 
      hjust = 0.5,
      color = "#4e4d47",
      margin = margin(b = -0.1, t = 0.43, l = 2, unit = "cm")
    ),
    
    plot.caption = element_text(
      size = 9,
      color = "#4e4d47",
      hjust = 0,
      margin = margin(b = 0.3, t = 0.3, unit = "cm")
    ),
    # Position de la légende
    legend.position = c(0.15, 0.25),
    legend.title = element_blank(),
    legend.text = element_text(size = 10, color = "grey40")
  )
map_dot
```


```{r carte de dorling}

bbox <- st_bbox(bailliage_sf)
x_min <- bbox[1]; x_max <- bbox[3]
y_min <- bbox[2]; y_max <- bbox[4]

map_dorling <- ggplot(dorling_viz) +
  geom_sf(
    aes(fill = cut(coefficient_incertitude_pct, 
                   breaks = c(0, 25, 50, 75, 100),
                   include.lowest = TRUE)),
    color = NA, 
    size = 0.08
  ) +
  scale_fill_manual(
    name = "Incertitude (%)",
    values = c("#1a9641", "#91cf60", "#fdae61", "#d7191c", "#872004")
  ) +
  coord_sf(clip = "off") +
  
  labs(
    title = "Dorling cartogram of the population in 1793",
    subtitle = "Uncertainty coefficient by bailliage",
    caption = paste(
      "Source: Cristofoli et al. (2017–2021). Données Cassini-communes France. EHESS.\nGay, V., Gobbi, P. E., and Goñi, M. « Bailliages in 1789 France », 2023.\nConception: N. Touati, 2025"
    )
  ) +
  
  theme_void() +
  theme(
    text = element_text(color = "#22211d"),
    plot.background = element_rect(fill = "#f5f5f2", color = NA),
    panel.background = element_rect(fill = "#f5f5f2", color = NA),
    legend.background = element_rect(fill = "#f5f5f2", color = NA),
    
    plot.title = element_text(
      size = 15, 
      hjust = 0.5, 
      color = "#4e4d47",
      face = "bold",
      margin = margin(b = -0.1, t = 0.4, l = 2, unit = "cm")
    ),
    
    plot.subtitle = element_text(
      size = 10, 
      hjust = 0.5,
      color = "#4e4d47",
      margin = margin(b = -0.1, t = 0.43, l = 2, unit = "cm")
    ),
    
    plot.caption = element_text(
      size = 8,
      color = "#4e4d47",
      hjust = 0,
      margin = margin(b = 0.3, t = 0.3, unit = "cm")
    ),
    
    legend.position = c(0.15, 0.25),
    legend.title = element_text(size = 10, face = "bold", color = "#4e4d47"),
    legend.text = element_text(size = 9, color = "#4e4d47")
  )

map_dorling
```



###  3.3 Export de la carte en png
```{r}
# === EXPORT PNG ===
ggsave(
  "carte_dorling_bailliage_1793.png",
  plot = map_dorling, 
  width = 2000/200,
  height = 1500/200,
  dpi = 300,        # Résolution
  bg = "white")

```


